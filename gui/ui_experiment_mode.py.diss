# -*- coding: utf-8 -*-

################################################################################
## Form generated from reading UI file 'æ›²çº¿æ‹Ÿåˆ-å®éªŒæ•°æ®æ¨¡å¼tSXeaE.ui'
##
## Created by: Qt User Interface Compiler version 6.10.0
##
## WARNING! All changes made in this file will be lost when recompiling UI file!
################################################################################

from PySide6.QtCore import (QCoreApplication, QDate, QDateTime, QLocale,
    QMetaObject, QObject, QPoint, QRect,
    QSize, QTime, QUrl, Qt)
from PySide6.QtGui import (QBrush, QColor, QConicalGradient, QCursor,
    QFont, QFontDatabase, QGradient, QIcon,
    QImage, QKeySequence, QLinearGradient, QPainter,
    QPalette, QPixmap, QRadialGradient, QTransform, QTextCursor)
from PySide6.QtWidgets import (QApplication, QComboBox, QDoubleSpinBox, QFrame,
    QGraphicsView, QLabel, QLineEdit, QMainWindow,
    QPushButton, QRadioButton, QSizePolicy, QStatusBar,
    QTextBrowser, QTextEdit, QWidget, QSpinBox)

class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        if not MainWindow.objectName():
            MainWindow.setObjectName(u"MainWindow")
        MainWindow.resize(1000, 800)
        MainWindow.setStyleSheet(u"QMianWindow{\n"
"	background-color: rgb(0, 255, 255);\n"
"}")
        self.centralwidget = QWidget(MainWindow)
        self.centralwidget.setObjectName(u"centralwidget")
        self.frame_5 = QFrame(self.centralwidget)
        self.frame_5.setObjectName(u"frame_5")
        self.frame_5.setGeometry(QRect(5, 5, 260, 300))
        self.frame_5.setFrameShape(QFrame.Shape.StyledPanel)
        self.frame_5.setFrameShadow(QFrame.Shadow.Raised)
        self.textEdit = QTextEdit(self.frame_5)
        self.textEdit.setObjectName(u"textEdit")
        self.textEdit.setGeometry(QRect(5, 35, 120, 260))
        self.textEdit.setStyleSheet(u"QTextEdit{\n"
"background : rgb(85, 255, 127)\n"
"}")
        self.label_8 = QLabel(self.frame_5)
        self.label_8.setObjectName(u"label_8")
        self.label_8.setGeometry(QRect(50, 10, 53, 20))
        font = QFont()
        font.setPointSize(11)
        self.label_8.setFont(font)
        self.textEdit_2 = QTextEdit(self.frame_5)
        self.textEdit_2.setObjectName(u"textEdit_2")
        self.textEdit_2.setGeometry(QRect(135, 35, 120, 260))
        self.textEdit_2.setStyleSheet(u"QTextEdit{\n"
"background : rgb(85, 255, 127)\n"
"}")
        self.label_9 = QLabel(self.frame_5)
        self.label_9.setObjectName(u"label_9")
        self.label_9.setGeometry(QRect(175, 10, 53, 20))
        self.label_9.setFont(font)
        self.pushButton_7 = QPushButton(self.centralwidget)
        self.pushButton_7.setObjectName(u"pushButton_7")
        self.pushButton_7.setGeometry(QRect(25, 310, 85, 30))
        font1 = QFont()
        font1.setPointSize(10)
        self.pushButton_7.setFont(font1)
        self.pushButton_7.setStyleSheet(u"QPushButton{\n"
"	background-color: rgb(0, 170, 0);\n"
"    color: rgb(255, 255, 255)\n"
"}\n"
"QPushButton:hover{\n"
"	background-color: rgb(85, 255, 127);\n"
"	color: rgb(0, 0, 0)\n"
"}\n"
"QPushButton:pressed{\n"
"	background-color: rgb(85, 170, 0);\n"
"	color: rgb(0, 0, 0)\n"
"}")
        self.frame_6 = QFrame(self.centralwidget)
        self.frame_6.setObjectName(u"frame_6")
        self.frame_6.setGeometry(QRect(5, 345, 260, 130))
        self.frame_6.setFrameShape(QFrame.Shape.StyledPanel)
        self.frame_6.setFrameShadow(QFrame.Shadow.Raised)
        self.label_10 = QLabel(self.frame_6)
        self.label_10.setObjectName(u"label_10")
        self.label_10.setGeometry(QRect(5, 5, 95, 25))
        self.label_10.setFont(font)
        self.label_11 = QLabel(self.frame_6)
        self.label_11.setObjectName(u"label_11")
        self.label_11.setGeometry(QRect(10, 35, 70, 20))
        self.label_11.setFont(font1)
        self.comboBox = QComboBox(self.frame_6)
        self.comboBox.setObjectName(u"comboBox")
        self.comboBox.setGeometry(QRect(80, 35, 120, 23))
        self.radioButton_13 = QRadioButton(self.frame_6)
        self.radioButton_13.setObjectName(u"radioButton_13")
        self.radioButton_13.setGeometry(QRect(10, 70, 120, 20))
        self.label_12 = QLabel(self.frame_6)
        self.label_12.setObjectName(u"label_12")
        self.label_12.setGeometry(QRect(20, 95, 90, 20))
        self.doubleSpinBox = QDoubleSpinBox(self.frame_6)
        self.doubleSpinBox.setObjectName(u"doubleSpinBox")
        self.doubleSpinBox.setGeometry(QRect(110, 95, 87, 23))
        # è¿­ä»£è¿‡æ»¤æ§ä»¶
        self.radioButton_15 = QRadioButton(self.frame_6)
        self.radioButton_15.setObjectName(u"radioButton_15")
        self.radioButton_15.setGeometry(QRect(10, 120, 120, 20))
        self.label_16 = QLabel(self.frame_6)
        self.label_16.setObjectName(u"label_16")
        self.label_16.setGeometry(QRect(140, 120, 70, 20))
        self.spinBox_iterations = QSpinBox(self.frame_6)
        self.spinBox_iterations.setObjectName(u"spinBox_iterations")
        self.spinBox_iterations.setGeometry(QRect(210, 120, 40, 23))
        self.spinBox_iterations.setMinimum(1)
        self.spinBox_iterations.setMaximum(10)
        self.spinBox_iterations.setValue(3)
        self.label_17 = QLabel(self.frame_6)
        self.label_17.setObjectName(u"label_17")
        self.label_17.setGeometry(QRect(20, 150, 110, 20))
        self.doubleSpinBox_iter_threshold = QDoubleSpinBox(self.frame_6)
        self.doubleSpinBox_iter_threshold.setObjectName(u"doubleSpinBox_iter_threshold")
        self.doubleSpinBox_iter_threshold.setGeometry(QRect(130, 150, 87, 23))
        self.doubleSpinBox_iter_threshold.setMinimum(0.001)
        self.doubleSpinBox_iter_threshold.setMaximum(100.0)
        self.doubleSpinBox_iter_threshold.setValue(0.1)
        # è°ƒæ•´frame_6çš„å¤§å°ä»¥å®¹çº³æ–°æ§ä»¶
        self.frame_6.setGeometry(QRect(5, 345, 260, 180))
        self.frame_7 = QFrame(self.centralwidget)
        self.frame_7.setObjectName(u"frame_7")
        self.frame_7.setGeometry(QRect(5, 530, 260, 100))
        self.frame_7.setFrameShape(QFrame.Shape.StyledPanel)
        self.frame_7.setFrameShadow(QFrame.Shadow.Raised)
        self.label_13 = QLabel(self.frame_7)
        self.label_13.setObjectName(u"label_13")
        self.label_13.setGeometry(QRect(5, 5, 110, 25))
        self.label_13.setFont(font)
        self.label_14 = QLabel(self.frame_7)
        self.label_14.setObjectName(u"label_14")
        self.label_14.setGeometry(QRect(20, 40, 53, 20))
        self.label_14.setFont(font1)
        self.label_15 = QLabel(self.frame_7)
        self.label_15.setObjectName(u"label_15")
        self.label_15.setGeometry(QRect(20, 70, 53, 20))
        self.label_15.setFont(font1)
        self.lineEdit_4 = QLineEdit(self.frame_7)
        self.lineEdit_4.setObjectName(u"lineEdit_4")
        self.lineEdit_4.setGeometry(QRect(60, 40, 113, 21))
        self.lineEdit_4.setStyleSheet(u"QLineEdit{\n"
"background : rgb(85, 255, 127)\n"
"}")
        self.lineEdit_5 = QLineEdit(self.frame_7)
        self.lineEdit_5.setObjectName(u"lineEdit_5")
        self.lineEdit_5.setGeometry(QRect(60, 70, 113, 21))
        self.lineEdit_5.setStyleSheet(u"QLineEdit{\n"
"background-color: rgb(85, 255, 127);\n"
"}")
        self.graphicsView = QGraphicsView(self.centralwidget)
        self.graphicsView.setObjectName(u"graphicsView")
        self.graphicsView.setGeometry(QRect(270, 5, 720, 580))
        self.textBrowser = QTextBrowser(self.centralwidget)
        self.textBrowser.setObjectName(u"textBrowser")
        self.textBrowser.setGeometry(QRect(270, 590, 720, 192))
        font = QFont()
        font.setPointSize(12)  # å¢å¤§å­—ä½“å¤§å°
        self.textBrowser.setFont(font)
        self.pushButton_8 = QPushButton(self.centralwidget)
        self.pushButton_8.setObjectName(u"pushButton_8")
        self.pushButton_8.setGeometry(QRect(60, 590, 140, 50))
        font2 = QFont()
        font2.setPointSize(14)
        self.pushButton_8.setFont(font2)
        self.pushButton_8.setStyleSheet(u"QPushButton{\n"
"	background-color: rgb(255, 150, 150);\n"
"	color: rgb(0, 0, 0);\n"
"}\n"
"QPushButton:hover{\n"
"	background-color: rgb(255, 0, 127);\n"
"	color: rgb(255, 255, 255);\n"
"}\n"
"QPushButton:pressed{\n"
"	background-color: rgb(200, 0, 0);\n"
"	color: rgb(255, 255, 255);\n"
"}")
        self.radioButton_14 = QRadioButton(self.centralwidget)
        self.radioButton_14.setObjectName(u"radioButton_14")
        self.radioButton_14.setGeometry(QRect(140, 660, 140, 30))
        self.pushButton_9 = QPushButton(self.centralwidget)
        self.pushButton_9.setObjectName(u"pushButton_9")
        self.pushButton_9.setGeometry(QRect(5, 650, 130, 45))
        self.pushButton_9.setFont(font)
        self.pushButton_9.setStyleSheet(u"QPushButton{\n"
"	background-color: rgb(255, 150, 150);\n"
"	color: rgb(0, 0, 0);\n"
"}\n"
"QPushButton:hover{\n"
"	background-color: rgb(255, 0, 127);\n"
"	color: rgb(255, 255, 255);\n"
"}\n"
"QPushButton:pressed{\n"
"	background-color: rgb(200, 0, 0);\n"
"	color: rgb(255, 255, 255);\n"
"}")
        self.pushButton_10 = QPushButton(self.centralwidget)
        self.pushButton_10.setObjectName(u"pushButton_10")
        self.pushButton_10.setGeometry(QRect(5, 710, 130, 45))
        self.pushButton_10.setFont(font)
        self.pushButton_10.setStyleSheet(u"QPushButton{\n"
"	background-color: rgb(255, 150, 150);\n"
"	color: rgb(0, 0, 0);\n"
"}\n"
"QPushButton:hover{\n"
"	background-color: rgb(255, 0, 127);\n"
"	color: rgb(255, 255, 255);\n"
"}\n"
"QPushButton:pressed{\n"
"	background-color: rgb(200, 0, 0);\n"
"	color: rgb(255, 255, 255);\n"
"}")
        self.pushButton_11 = QPushButton(self.centralwidget)
        self.pushButton_11.setObjectName(u"pushButton_11")
        self.pushButton_11.setGeometry(QRect(140, 710, 130, 45))
        self.pushButton_11.setFont(font)
        self.pushButton_11.setStyleSheet(u"QPushButton{\n"
"	background-color: rgb(255, 0, 0);\n"
"	color: rgb(255, 255, 255);\n"
"}\n"
"QPushButton:hover{\n"
"	background-color: rgb(255, 60, 150);\n"
"	color: rgb(0, 0, 0);\n"
"}\n"
"QPushButton:pressed{\n"
"	background-color: rgb(214, 50, 127);\n"
"	color: rgb(0, 0, 0);\n"
"}")
        MainWindow.setCentralWidget(self.centralwidget)
        self.statusbar = QStatusBar(MainWindow)
        self.statusbar.setObjectName(u"statusbar")
        MainWindow.setStatusBar(self.statusbar)

        self.retranslateUi(MainWindow)

        QMetaObject.connectSlotsByName(MainWindow)
    # setupUi

    def retranslateUi(self, MainWindow):
        MainWindow.setWindowTitle(QCoreApplication.translate("MainWindow", u"\u66f2\u7ebf\u62df\u5408-\u5b9e\u9a8c\u6570\u636e\u6a21\u5f0f", None))
        self.label_8.setText(QCoreApplication.translate("MainWindow", u"X\u5750\u6807", None))
        self.label_9.setText(QCoreApplication.translate("MainWindow", u"Y\u5750\u6807", None))
        self.pushButton_7.setText(QCoreApplication.translate("MainWindow", u"\u663e\u793a\u793a\u4f8b\u6570\u636e", None))
        self.label_10.setText(QCoreApplication.translate("MainWindow", u"\u914d\u7f6e\u62df\u5408\u4fe1\u606f", None))
        self.label_11.setText(QCoreApplication.translate("MainWindow", u"\u62df\u5408\u65b9\u5f0f\uff1a", None))
        self.radioButton_13.setText(QCoreApplication.translate("MainWindow", u"\u662f\u5426\u8fc7\u6ee4\u5f02\u5e38\u503c", None))
        self.label_12.setText(QCoreApplication.translate("MainWindow", u"\u5f02\u5e38\u503c\u9608\u503c\uff1a", None))
        self.radioButton_15.setText(QCoreApplication.translate("MainWindow", u"\u8fed\u4ee3\u8fc7\u6ee4", None))
        self.label_16.setText(QCoreApplication.translate("MainWindow", u"\u8fed\u4ee3\u6b65\u6570\uff1a", None))
        self.label_17.setText(QCoreApplication.translate("MainWindow", u"\u8fed\u4ee3\u9608\u503c\uff1a", None))
        self.label_13.setText(QCoreApplication.translate("MainWindow", u"\u914d\u7f6e\u5750\u6807\u8f74\u4fe1\u606f", None))
        self.label_14.setText(QCoreApplication.translate("MainWindow", u"X\u8f74\uff1a", None))
        self.label_15.setText(QCoreApplication.translate("MainWindow", u"Y\u8f74\uff1a", None))
        self.pushButton_8.setText(QCoreApplication.translate("MainWindow", u"\u7ed8\u5236\u62df\u5408\u66f2\u7ebf", None))
        self.radioButton_14.setText(QCoreApplication.translate("MainWindow", u"\u540c\u65f6\u8f93\u51fa\u5408\u7406\u6027\u5206\u6790", None))
        self.pushButton_9.setText(QCoreApplication.translate("MainWindow", u"\u8f93\u51fa\u7edf\u8ba1\u5b66\u6570\u636e", None))
        self.pushButton_10.setText(QCoreApplication.translate("MainWindow", u"\u5bfc\u51fa\u4e3a\u56fe\u7247", None))
        self.pushButton_11.setText(QCoreApplication.translate("MainWindow", u"\u8fd4\u56de\u6a21\u5f0f\u9009\u62e9", None))
    # retranslateUi

from PySide6.QtWidgets import QMainWindow, QGraphicsScene, QMessageBox
from PySide6.QtCore import Qt
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure
import io
from PIL import Image

# å¯¼å…¥å·¥å…·å‡½æ•°
from utils.experiment_mode_utils import experiment_mode_analysis, find_best_polynomial_fit, \
    evaluate_curve_quality, format_experiment_results, generate_experiment_plot_data
from utils.fitting_functions import filter_outliers, get_function_info, fit_data

class ExperimentModeWindow(QMainWindow):
    """å®éªŒæ•°æ®æ¨¡å¼çª—å£"""
    def __init__(self):
        super().__init__()
        
        # è®¾ç½®UI
        self.ui = Ui_MainWindow()
        self.ui.setupUi(self)
        
        # åˆå§‹åŒ–æ•°æ®
        self.x_data = []
        self.y_data = []
        
        # åˆå§‹åŒ–ç»˜å›¾
        self.init_plot()
        
        # è®¾ç½®æ‹Ÿåˆæ–¹æ³•ä¸‹æ‹‰æ¡†
        self.ui.comboBox.addItems(['å¤šé¡¹å¼æ‹Ÿåˆ', 'å¹³æ»‘æ ·æ¡æ‹Ÿåˆ'])
        
        # è¿æ¥ä¿¡å·å’Œæ§½
        self.ui.pushButton_7.clicked.connect(self.show_example_data)
        self.ui.pushButton_8.clicked.connect(self.draw_fitting_curve)
        self.ui.pushButton_9.clicked.connect(self.output_statistics)
        self.ui.pushButton_10.clicked.connect(self.export_as_image)
        self.ui.pushButton_11.clicked.connect(self.return_to_mode_select)
        
        # è®¾ç½®çª—å£å±æ€§
        self.setWindowTitle("æ›²çº¿æ‹Ÿåˆ-å®éªŒæ•°æ®æ¨¡å¼")
        self.setFixedSize(1000, 800)
    
    def init_plot(self):
        """åˆå§‹åŒ–ç»˜å›¾åŒºåŸŸ"""
        self.scene = QGraphicsScene()
        self.ui.graphicsView.setScene(self.scene)
        
        # åˆ›å»ºmatplotlibå›¾å½¢
        self.fig = Figure(figsize=(7, 5), dpi=100)
        self.ax = self.fig.add_subplot(111)
        self.canvas = FigureCanvas(self.fig)
        self.scene.addWidget(self.canvas)
        
        # è®¾ç½®ä¸­æ–‡æ˜¾ç¤º
        plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'Microsoft YaHei', 'SimHei']  # ä¼˜å…ˆä½¿ç”¨æ”¯æŒç‰¹æ®Šå­—ç¬¦çš„å­—ä½“
        plt.rcParams['axes.unicode_minus'] = False  # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºè´Ÿå·
    
    def show_example_data(self):
        """æ˜¾ç¤ºç¤ºä¾‹æ•°æ®"""
        # ç”Ÿæˆç¤ºä¾‹æ•°æ®
        x = np.linspace(0, 10, 20)
        y = 2 * x**2 + 3 * x + 1 + np.random.normal(0, 5, 20)
        
        # æ·»åŠ ä¸€äº›å¼‚å¸¸å€¼
        y[3] += 50
        y[15] -= 40
        
        # å¡«å……åˆ°æ–‡æœ¬æ¡†
        self.ui.textEdit.setPlainText('\n'.join([f'{val:.4f}' for val in x]))
        self.ui.textEdit_2.setPlainText('\n'.join([f'{val:.4f}' for val in y]))
        
        # æ›´æ–°å†…éƒ¨æ•°æ®
        self.x_data = x.tolist()
        self.y_data = y.tolist()
        
        # æ˜¾ç¤ºæç¤º
        QMessageBox.information(self, "æˆåŠŸ", "ç¤ºä¾‹æ•°æ®å·²åŠ è½½")
    
    def parse_input_data(self):
        """è§£æè¾“å…¥æ•°æ®"""
        try:
            # ä»æ–‡æœ¬æ¡†è·å–æ•°æ®
            x_text = self.ui.textEdit.toPlainText()
            y_text = self.ui.textEdit_2.toPlainText()
            
            # åˆ†å‰²å¹¶è½¬æ¢ä¸ºæµ®ç‚¹æ•°
            x_data = [float(line.strip()) for line in x_text.split('\n') if line.strip()]
            y_data = [float(line.strip()) for line in y_text.split('\n') if line.strip()]
            
            # æ£€æŸ¥æ•°æ®é•¿åº¦æ˜¯å¦ä¸€è‡´
            if len(x_data) != len(y_data):
                QMessageBox.warning(self, "æ•°æ®é”™è¯¯", "Xå’ŒYæ•°æ®é•¿åº¦ä¸ä¸€è‡´")
                return None, None
            
            # æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©º
            if not x_data or not y_data:
                QMessageBox.warning(self, "æ•°æ®é”™è¯¯", "è¯·è¾“å…¥æ•°æ®")
                return None, None
            
            return x_data, y_data
        except Exception as e:
            QMessageBox.warning(self, "æ•°æ®é”™è¯¯", f"æ•°æ®æ ¼å¼é”™è¯¯: {str(e)}")
            return None, None
    
    def draw_fitting_curve(self):
        """ç»˜åˆ¶æ‹Ÿåˆæ›²çº¿å¹¶æ˜¾ç¤ºè¯¦ç»†åˆ†æç»“æœï¼Œæ”¯æŒåŒæ—¶è¾“å‡ºåˆç†æ€§åˆ†æé€‰é¡¹"""
        # æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        self.statusBar().showMessage("æ­£åœ¨å¤„ç†æ•°æ®å¹¶è¿›è¡Œæ‹Ÿåˆåˆ†æ...")
        
        # è§£æè¾“å…¥æ•°æ®
        x_data, y_data = self.parse_input_data()
        if x_data is None or y_data is None:
            self.statusBar().showMessage("æ•°æ®è§£æå¤±è´¥", 3000)
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·å…ˆè¾“å…¥æ•°æ®")
            return
        
        # æ›´æ–°å†…éƒ¨æ•°æ®
        self.x_data = x_data
        self.y_data = y_data
        
        # è·å–æ‹Ÿåˆå‚æ•°
        fit_method = self.ui.comboBox.currentText()
        filter_outlier = self.ui.radioButton_13.isChecked()
        outlier_threshold = self.ui.doubleSpinBox.value() if filter_outlier else 3.0
        enable_iterative_filter = self.ui.radioButton_15.isChecked()
        iteration_count = self.ui.spinBox_iterations.value() if enable_iterative_filter else 0
        iteration_threshold = self.ui.doubleSpinBox_iter_threshold.value() if enable_iterative_filter else 0.1
        show_rationality = self.ui.radioButton_14.isChecked()
        
        # å‡†å¤‡æ•°æ®ç”¨äºåˆ†æ
        x_array = np.array(x_data)
        y_array = np.array(y_data)
        
        # æ‰§è¡Œå®Œæ•´çš„å®éªŒæ¨¡å¼åˆ†æ
        try:
            # è°ƒç”¨å®éªŒæ¨¡å¼åˆ†æå‡½æ•°ï¼Œè·å–å®Œæ•´çš„åˆ†æç»“æœ
            analysis_results = experiment_mode_analysis(
                x_array, 
                y_array, 
                enable_outlier_filter=filter_outlier,
                outlier_threshold=outlier_threshold,
                fit_method=fit_method,
                enable_iterative_filter=enable_iterative_filter,
                iteration_count=iteration_count,
                iteration_threshold=iteration_threshold
            )
            
            # ä»åˆ†æç»“æœä¸­è·å–æ•°æ®
            filtered_x, filtered_y = analysis_results.get('filtered_data', (x_array, y_array))
            filtered_indices = analysis_results.get('filtered_indices', [])
            
            # ç¡®å®šæ‹Ÿåˆæ›²çº¿æ•°æ®
            if 'best_poly_fit' in analysis_results and analysis_results['best_poly_fit']:
                # å¤šé¡¹å¼æ‹Ÿåˆ
                best_fit = analysis_results['best_poly_fit']
                x_smooth = np.linspace(min(filtered_x) * 0.9, max(filtered_x) * 1.1, 1000)
                y_fit = np.polyval(best_fit['coeffs'], x_smooth)
            elif 'smooth_curve' in analysis_results and analysis_results['smooth_curve']:
                # å¹³æ»‘æ ·æ¡æ‹Ÿåˆ
                x_smooth, y_fit = analysis_results['smooth_curve']
            else:
                # å¦‚æœæ²¡æœ‰æ‹Ÿåˆæ›²çº¿ï¼Œç”Ÿæˆé»˜è®¤çš„
                x_smooth = np.linspace(min(filtered_x) * 0.9, max(filtered_x) * 1.1, 1000)
                y_fit = np.zeros_like(x_smooth)  # å ä½ç¬¦
            
            # ç»˜åˆ¶å›¾å½¢
            self.ax.clear()
            
            # ç»˜åˆ¶åŸå§‹æ•°æ®ç‚¹
            self.ax.scatter(x_array, y_array, color='blue', alpha=0.6, label='åŸå§‹æ•°æ®')
            
            # å¦‚æœè¿‡æ»¤äº†å¼‚å¸¸å€¼ï¼Œåªæ˜¾ç¤ºç”¨çº¢å‰æ ‡æ³¨çš„å¼‚å¸¸ç‚¹
            if filtered_indices:
                # æ ‡è®°è¢«è¿‡æ»¤çš„å¼‚å¸¸ç‚¹
                outlier_x = x_array[filtered_indices]
                outlier_y = y_array[filtered_indices]
                self.ax.scatter(outlier_x, outlier_y, color='red', s=100, alpha=0.7, marker='x', label='å¼‚å¸¸ç‚¹')
            elif len(filtered_x) < len(x_array):
                # å…¼å®¹æ—§ç‰ˆæœ¬çš„è¿‡æ»¤æ–¹å¼ï¼ŒåŒæ ·åªæ ‡è®°å¼‚å¸¸ç‚¹
                # æ‰¾å‡ºè¢«è¿‡æ»¤çš„å¼‚å¸¸ç‚¹ç´¢å¼•
                kept_set = set(zip(filtered_x, filtered_y))
                outlier_x = []
                outlier_y = []
                for i, (x, y) in enumerate(zip(x_array, y_array)):
                    if (x, y) not in kept_set:
                        outlier_x.append(x)
                        outlier_y.append(y)
                if outlier_x:
                    self.ax.scatter(outlier_x, outlier_y, color='red', s=100, alpha=0.7, marker='x', label='å¼‚å¸¸ç‚¹')
            
            # ç»˜åˆ¶æ‹Ÿåˆæ›²çº¿
            self.ax.plot(x_smooth, y_fit, color='red', linewidth=2, label='æ‹Ÿåˆæ›²çº¿')
            
            # è®¾ç½®åæ ‡è½´æ ‡ç­¾
            x_label = self.ui.lineEdit_4.text() if self.ui.lineEdit_4.text() else 'Xè½´'
            y_label = self.ui.lineEdit_5.text() if self.ui.lineEdit_5.text() else 'Yè½´'
            self.ax.set_xlabel(x_label)
            self.ax.set_ylabel(y_label)
            
            # æ·»åŠ æ ‡é¢˜å’Œå›¾ä¾‹
            self.ax.set_title(f'å®éªŒæ•°æ®{"å¤šé¡¹å¼" if fit_method == "å¤šé¡¹å¼æ‹Ÿåˆ" else "å¹³æ»‘æ ·æ¡"}æ‹Ÿåˆæ›²çº¿')
            self.ax.legend()
            self.ax.grid(True, linestyle='--', alpha=0.7)
            
            # æ›´æ–°ç”»å¸ƒ
            self.fig.tight_layout()
            self.canvas.draw()
            
            # æ ¹æ®é€‰é¡¹å†³å®šè¾“å‡ºå†…å®¹
            if show_rationality:
                # ä½¿ç”¨å¢å¼ºçš„æ ¼å¼åŒ–å‡½æ•°ç”Ÿæˆè¯¦ç»†ç»“æœ
                detailed_results = format_experiment_results(analysis_results)
            else:
                # å……åˆ†åˆ©ç”¨_generate_simplified_resultså‡½æ•°ï¼Œæä¾›æ›´ç›´è§‚çš„ç»“æœæ‘˜è¦
                detailed_results = self._generate_simplified_results(analysis_results)
            
            # æ˜¾ç¤ºç»“æœ
            self.ui.textBrowser.setText(detailed_results)
            
            # æ»šåŠ¨åˆ°é¡¶éƒ¨
            self.ui.textBrowser.moveCursor(QTextCursor.Start)
            
            # æ›´æ–°çŠ¶æ€æ 
            data_points = len(filtered_x)
            outliers = len(filtered_indices)
            status_msg = f"æ‹Ÿåˆå®Œæˆ - æ•°æ®ç‚¹: {data_points}, å¼‚å¸¸ç‚¹: {outliers}"
            if 'best_poly_fit' in analysis_results and analysis_results['best_poly_fit'] and 'r_squared' in analysis_results['best_poly_fit']:
                status_msg += f", RÂ²: {analysis_results['best_poly_fit']['r_squared']:.4f}"
            if 'iteration_history' in analysis_results:
                status_msg += f", è¿­ä»£æ¬¡æ•°: {len(analysis_results['iteration_history'])}"
            self.statusBar().showMessage(status_msg, 5000)
            
        except Exception as e:
            import traceback
            self.statusBar().showMessage("æ‹Ÿåˆè¿‡ç¨‹å‡ºé”™", 3000)
            QMessageBox.critical(self, "é”™è¯¯", f"æ‹Ÿåˆè¿‡ç¨‹å‡ºé”™: {str(e)}")
            # æ·»åŠ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯åˆ°æ–‡æœ¬æµè§ˆå™¨ä»¥ä¾¿è°ƒè¯•
            self.ui.textBrowser.setText(f"æ‹Ÿåˆè¿‡ç¨‹å‡ºé”™: {str(e)}")
            self.ui.textBrowser.append(f"\nè¯¦ç»†é”™è¯¯ä¿¡æ¯:\n{traceback.format_exc()}")
            
    def _generate_simplified_results(self, analysis_results: dict) -> str:
        """ç”Ÿæˆç®€åŒ–ç‰ˆçš„ç»“æœè¾“å‡ºï¼Œèšç„¦å…³é”®ä¿¡æ¯"""
        output = []
        
        # åŸºæœ¬ä¿¡æ¯
        output.append("=== æ‹Ÿåˆç»“æœæ¦‚è§ˆ ===")
        output.append("=" * 30)
        output.append(f"åŸå§‹æ•°æ®ç‚¹æ•°é‡: {len(analysis_results['original_data'][0])}")
        output.append(f"è¿‡æ»¤åæ•°æ®ç‚¹æ•°é‡: {len(analysis_results['filtered_data'][0])}")
        
        if len(analysis_results['filtered_indices']) > 0:
            outlier_percent = len(analysis_results['filtered_indices']) / len(analysis_results['original_data'][0]) * 100
            output.append(f"è¿‡æ»¤çš„å¼‚å¸¸ç‚¹: {len(analysis_results['filtered_indices'])} ({outlier_percent:.1f}%)")
        
        # æ‹Ÿåˆä¿¡æ¯
        quality = analysis_results['curve_quality']
        output.append("\n=== æ‹Ÿåˆè´¨é‡ ===")
        output.append(f"æ‹Ÿåˆä¼˜åº¦ç­‰çº§: {quality['goodness_of_fit']}")
        output.append(f"æ•°æ®ä»£è¡¨æ€§: {quality['data_representativeness']}")
        
        # æ–°å¢ï¼šæ®‹å·®æ­£æ€åˆ†å¸ƒåˆç†æ€§åˆ¤æ–­
        if 'normality_analysis' in quality and quality['normality_analysis']:
            normality_analysis = quality['normality_analysis']
            normality_icon = "âœ…" if normality_analysis['normality_assessment'] == "è‰¯å¥½" else "âš ï¸" if normality_analysis['normality_assessment'] == "ä¸€èˆ¬" else "âŒ"
            output.append(f"\n=== åˆç†æ€§åˆ¤æ–­ ===")
            output.append(f"{normality_icon} æ­£æ€æ€§è¯„ä¼°: {normality_analysis['normality_assessment']}")
            # åªæ˜¾ç¤ºæœ€æ ¸å¿ƒçš„è§£é‡Šï¼Œé¿å…è¾“å‡ºè¿‡é•¿
            interpretation = normality_analysis['normality_interpretation']
            if len(interpretation) > 60:
                interpretation = interpretation[:57] + "..."
            output.append(f"è§£é‡Š: {interpretation}")
        
        # å…³é”®è¯¯å·®æŒ‡æ ‡
        if quality['error_analysis']:
            error_analysis = quality['error_analysis']
            output.append(f"å‡æ–¹æ ¹è¯¯å·®(RMSE): {error_analysis.get('std_error', 0):.6f}")
            if 'mean_relative_error' in error_analysis:
                output.append(f"å¹³å‡ç›¸å¯¹è¯¯å·®: {error_analysis['mean_relative_error']:.2f}%")
        
        # ç®€è¦å»ºè®®
            if quality['recommendations']:
                output.append("\n=== ä¸»è¦å»ºè®® ===")
                # åªæ˜¾ç¤ºå‰3æ¡æœ€é‡è¦çš„å»ºè®®
                for i, rec in enumerate(quality['recommendations'][:3], 1):
                    output.append(f"{i}. {rec}")
                if len(quality['recommendations']) > 3:
                    output.append(f"... è¿˜æœ‰ {len(quality['recommendations']) - 3} æ¡å»ºè®®ï¼Œè¯·ç‚¹å‡»'è¾“å‡ºç»Ÿè®¡å­¦æ•°æ®'æŸ¥çœ‹å®Œæ•´åˆ†æ")
            
            # è¿­ä»£è¿‡æ»¤ä¿¡æ¯
            if 'iteration_history' in analysis_results and analysis_results['iteration_history']:
                output.append("\n=== è¿­ä»£è¿‡æ»¤ä¿¡æ¯ ===")
                output.append(f"è¿­ä»£æ¬¡æ•°: {len(analysis_results['iteration_history'])}")
                for iter_info in analysis_results['iteration_history']:
                    output.append(f"ç¬¬{iter_info['iteration']}æ¬¡è¿­ä»£: ç§»é™¤{iter_info['removed_count']}ç‚¹, "
                                 f"å‰©ä½™{iter_info['remaining_count']}ç‚¹")
        
        return "\n".join(output)
    
    def output_statistics(self):
        """è¾“å‡ºæ•°æ®çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ"""
        try:
            # ç¡®ä¿æœ‰æ•°æ®
            if not self.x_data or not self.y_data:
                QMessageBox.warning(self, "è­¦å‘Š", "è¯·å…ˆç»˜åˆ¶æ‹Ÿåˆæ›²çº¿")
                return
            
            # æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            self.statusBar().showMessage("æ­£åœ¨ç”Ÿæˆè¯¦ç»†ç»Ÿè®¡åˆ†æ...")
            
            # å‡†å¤‡æ•°æ®ç”¨äºåˆ†æ
            x_array = np.array(self.x_data)
            y_array = np.array(self.y_data)
            
            # è·å–å½“å‰è®¾ç½®çš„å‚æ•°
            filter_outlier = self.ui.radioButton_13.isChecked()
            outlier_threshold = self.ui.doubleSpinBox.value() if filter_outlier else 3.0
            enable_iterative_filter = self.ui.radioButton_15.isChecked()
            iteration_count = self.ui.spinBox_iterations.value() if enable_iterative_filter else 0
            iteration_threshold = self.ui.doubleSpinBox_iter_threshold.value() if enable_iterative_filter else 0.1
            fit_method = self.ui.comboBox.currentText()
            
            # è°ƒç”¨å®éªŒæ¨¡å¼åˆ†æå‡½æ•°ï¼Œè·å–å®Œæ•´çš„åˆ†æç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
            analysis_results = experiment_mode_analysis(
                x_array, 
                y_array, 
                enable_outlier_filter=filter_outlier,
                outlier_threshold=outlier_threshold,
                fit_method=fit_method,
                enable_iterative_filter=enable_iterative_filter,
                iteration_count=iteration_count,
                iteration_threshold=iteration_threshold
            )
            
            # ä½¿ç”¨format_experiment_resultsç”Ÿæˆè¯¦ç»†çš„ç»Ÿè®¡å’Œåˆ†æç»“æœ
            detailed_results = format_experiment_results(analysis_results)
            
            # æ˜¾ç¤ºç»“æœ
            self.ui.textBrowser.setText(detailed_results)
            
            # æ»šåŠ¨åˆ°é¡¶éƒ¨
            self.ui.textBrowser.moveCursor(QTextCursor.Start)
            
            # å®Œæˆåæ›´æ–°çŠ¶æ€æ 
            data_points = len(analysis_results['filtered_data'][0])
            outliers = len(analysis_results['filtered_indices'])
            status_msg = f"ç»Ÿè®¡åˆ†æå®Œæˆ - æ•°æ®ç‚¹: {data_points}, å¼‚å¸¸ç‚¹: {outliers}"
            if 'iteration_history' in analysis_results:
                status_msg += f", è¿­ä»£æ¬¡æ•°: {len(analysis_results['iteration_history'])}"
            self.statusBar().showMessage(status_msg, 5000)
            
        except Exception as e:
            self.statusBar().showMessage("ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯æ—¶å‡ºé”™", 3000)
            import traceback
            self.ui.textBrowser.setText(f"è®¡ç®—ç»Ÿè®¡ä¿¡æ¯æ—¶å‡ºé”™: {str(e)}")
            self.ui.textBrowser.append(f"\nè¯¦ç»†é”™è¯¯ä¿¡æ¯:\n{traceback.format_exc()}")
    
    def _generate_simplified_results(self, analysis_results: dict) -> str:
        """ç”Ÿæˆç®€åŒ–ç‰ˆçš„ç»“æœï¼Œç”¨äºåœ¨ç»˜å›¾æ—¶å¿«é€Ÿæ˜¾ç¤º"""
        output = []
        output.append("ğŸ“Š å®éªŒæ‹Ÿåˆç»“æœæ‘˜è¦ ğŸ“Š")
        output.append("=" * 40)
        
        # åŸºæœ¬ä¿¡æ¯
        output.append(f"æ•°æ®ç‚¹æ•°é‡: {len(analysis_results['filtered_data'][0])}")
        if len(analysis_results['filtered_indices']) > 0:
            outlier_percent = len(analysis_results['filtered_indices']) / len(analysis_results['original_data'][0]) * 100
            output.append(f"å¼‚å¸¸ç‚¹: {len(analysis_results['filtered_indices'])} ({outlier_percent:.1f}%)")
        
        # å¤šé¡¹å¼æ‹Ÿåˆç»“æœ
        if 'best_poly_fit' in analysis_results and analysis_results['best_poly_fit']:
            poly = analysis_results['best_poly_fit']
            output.append("\nğŸ” å¤šé¡¹å¼æ‹Ÿåˆ:")
            output.append(f"  é˜¶æ•°: {poly['degree']}")
            if 'r_squared' in poly:
                output.append(f"  RÂ²: {poly['r_squared']:.4f}")
            if 'rmse' in poly:
                output.append(f"  RMSE: {poly['rmse']:.6f}")
                
            # è¿‡æ‹Ÿåˆé£é™©ç®€è¦æç¤º
            if 'adjusted_r_squared' in poly:
                r_diff = poly['r_squared'] - poly['adjusted_r_squared']
                if r_diff > 0.1:
                    output.append("  âš ï¸ æ³¨æ„: å¯èƒ½å­˜åœ¨è¿‡æ‹Ÿåˆé£é™©")
        
        # æ–°å¢ï¼šæ®‹å·®æ­£æ€åˆ†å¸ƒåˆç†æ€§åˆ¤æ–­ï¼ˆé’ˆå¯¹ç»˜å›¾æ˜¾ç¤ºçš„ç®€åŒ–ç‰ˆï¼‰
        if 'curve_quality' in analysis_results and analysis_results['curve_quality']:
            quality = analysis_results['curve_quality']
            if 'normality_analysis' in quality and quality['normality_analysis']:
                normality_analysis = quality['normality_analysis']
                normality_icon = "âœ…" if normality_analysis['normality_assessment'] == "è‰¯å¥½" else "âš ï¸" if normality_analysis['normality_assessment'] == "ä¸€èˆ¬" else "âŒ"
                output.append("\nğŸ“Š åˆç†æ€§åˆ¤æ–­:")
                output.append(f"  {normality_icon} æ­£æ€æ€§: {normality_analysis['normality_assessment']}")
        
        # å¹³æ»‘æ›²çº¿ä¿¡æ¯
        if 'smooth_curve' in analysis_results and analysis_results['smooth_curve']:
            output.append("\nğŸ“ˆ å¹³æ»‘æ ·æ¡æ‹Ÿåˆå·²å®Œæˆ")
        
        # è´¨é‡è¯„ä¼°ç®€è¦ä¿¡æ¯
        quality = analysis_results['curve_quality']
        output.append("\nğŸŒŸ è´¨é‡è¯„ä¼°:")
        output.append(f"  æ‹Ÿåˆä¼˜åº¦: {quality['goodness_of_fit']}")
        output.append(f"  æ•°æ®ä»£è¡¨æ€§: {quality['data_representativeness']}")
        
        # è¿­ä»£è¿‡æ»¤ä¿¡æ¯
        if 'iteration_history' in analysis_results and analysis_results['iteration_history']:
            output.append("\nğŸ”„ è¿­ä»£è¿‡æ»¤ç»“æœ:")
            output.append(f"  è¿­ä»£æ¬¡æ•°: {len(analysis_results['iteration_history'])}")
            for iter_info in analysis_results['iteration_history']:
                output.append(f"  ç¬¬{iter_info['iteration']}æ¬¡: -{iter_info['removed_count']}ç‚¹, "
                             f"å‰©ä½™{iter_info['remaining_count']}ç‚¹")
        
        # å…³é”®å»ºè®®
        output.append("\nğŸ’¡ å…³é”®å»ºè®®:")
        # æå–æœ€é‡è¦çš„2-3æ¡å»ºè®®
        recommendations = []
        n_points = len(analysis_results['filtered_data'][0])
        if n_points < 10:
            recommendations.append("å¢åŠ æ ·æœ¬é‡è‡³å°‘è‡³10ä¸ªæ•°æ®ç‚¹")
        
        if 'best_poly_fit' in analysis_results and analysis_results['best_poly_fit']:
            poly = analysis_results['best_poly_fit']
            if poly.get('degree', 0) > 4:
                recommendations.append("è€ƒè™‘é™ä½å¤šé¡¹å¼é˜¶æ•°ä»¥é¿å…è¿‡æ‹Ÿåˆ")
        
        # å¼‚å¸¸ç‚¹å»ºè®®
        if len(analysis_results['filtered_indices']) > 0:
            outlier_percent = len(analysis_results['filtered_indices']) / len(analysis_results['original_data'][0]) * 100
            if outlier_percent > 20:
                recommendations.append("å¼‚å¸¸ç‚¹æ¯”ä¾‹è¿‡é«˜ï¼Œå»ºè®®æ£€æŸ¥åŸå§‹æ•°æ®")
        
        if recommendations:
            for i, rec in enumerate(recommendations[:3], 1):
                output.append(f"  {i}. {rec}")
        else:
            output.append("  âœ… å½“å‰æ‹Ÿåˆæƒ…å†µè‰¯å¥½")
        
        output.append("\nğŸ’¡ æç¤º: ç‚¹å‡»'è¾“å‡ºç»Ÿè®¡ä¿¡æ¯'æŸ¥çœ‹è¯¦ç»†åˆ†æ")
        
        return "\n".join(output)
    
    def export_as_image(self):
        """å¯¼å‡ºä¸ºå›¾ç‰‡"""
        # æ£€æŸ¥æ˜¯å¦æœ‰ç»˜åˆ¶çš„å›¾å½¢
        if not self.ax.lines and not self.ax.collections:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·å…ˆç»˜åˆ¶æ‹Ÿåˆæ›²çº¿")
            return
        
        try:
            # åˆ›å»ºç¼“å†²åŒº
            buffer = io.BytesIO()
            
            # ä¿å­˜å›¾å½¢åˆ°ç¼“å†²åŒº
            self.fig.savefig(buffer, format='png', dpi=300, bbox_inches='tight')
            buffer.seek(0)
            
            # ä½¿ç”¨PILä¿å­˜å›¾ç‰‡
            img = Image.open(buffer)
            img.save('å®éªŒæ•°æ®æ‹Ÿåˆç»“æœ.png')
            
            QMessageBox.information(self, "æˆåŠŸ", "å›¾ç‰‡å·²ä¿å­˜ä¸º 'å®éªŒæ•°æ®æ‹Ÿåˆç»“æœ.png'")
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"ä¿å­˜å›¾ç‰‡å¤±è´¥: {str(e)}")
    
    def smooth_curve(self, x, y):
        """å¯¹æ›²çº¿è¿›è¡Œå¹³æ»‘å¤„ç†ï¼Œä½¿ç”¨æ›´é«˜çº§çš„æ ·æ¡æ’å€¼æ–¹æ³•"""
        # æ’åºæ•°æ®ç‚¹
        sorted_indices = np.argsort(x)
        sorted_x = x[sorted_indices]
        sorted_y = y[sorted_indices]
        
        try:
            # å°è¯•ä½¿ç”¨scipyçš„æ ·æ¡æ’å€¼
            from scipy.interpolate import make_interp_spline
            
            # ä¸ºäº†æ›´å¥½çš„å¹³æ»‘æ•ˆæœï¼Œä½¿ç”¨3æ¬¡æ ·æ¡ï¼Œä½†æ•°æ®ç‚¹ä¸è¶³æ—¶é™ä½é˜¶æ•°
            k = min(3, len(sorted_x) - 1)
            if k >= 1:
                spl = make_interp_spline(sorted_x, sorted_y, k=k)
                # ç”Ÿæˆå¹³æ»‘æ›²çº¿
                smoothed_y = spl(sorted_x)
                
                # æ¢å¤åŸå§‹é¡ºåº
                original_order = np.argsort(sorted_indices)
                return smoothed_y[original_order]
        except ImportError:
            # å¦‚æœæ²¡æœ‰scipyï¼Œä½¿ç”¨ç§»åŠ¨å¹³å‡
            pass
        except Exception:
            # å¦‚æœæ ·æ¡æ’å€¼å¤±è´¥ï¼Œä½¿ç”¨ç§»åŠ¨å¹³å‡
            pass
        
        # ä½¿ç”¨ç§»åŠ¨å¹³å‡ä½œä¸ºåå¤‡æ–¹æ¡ˆ
        window_size = max(2, min(5, len(y) // 3))
        smoothed_y = np.convolve(sorted_y, np.ones(window_size)/window_size, mode='same')
        
        # å¤„ç†è¾¹ç•Œæƒ…å†µ
        smoothed_y[0] = sorted_y[0]
        smoothed_y[-1] = sorted_y[-1]
        
        # æ¢å¤åŸå§‹é¡ºåº
        original_order = np.argsort(sorted_indices)
        return smoothed_y[original_order]
    
    def _detect_outliers(self, x, y):
        """æ£€æµ‹æ•°æ®ä¸­çš„å¼‚å¸¸ç‚¹ï¼Œä½¿ç”¨IQRæ–¹æ³•"""
        # ä½¿ç”¨IQRæ–¹æ³•æ£€æµ‹å¼‚å¸¸ç‚¹
        if len(x) > 3:
            # ä½¿ç”¨ç®€å•çº¿æ€§å›å½’è®¡ç®—æ®‹å·®
            try:
                # è®¡ç®—æ®‹å·®
                z = np.polyfit(x, y, 1)
                p = np.poly1d(z)
                residuals = y - p(x)
                
                # è®¡ç®—IQR
                Q1 = np.percentile(residuals, 25)
                Q3 = np.percentile(residuals, 75)
                IQR = Q3 - Q1
                
                # å®šä¹‰å¼‚å¸¸å€¼è¾¹ç•Œ
                lower_bound = Q1 - 1.5 * IQR
                upper_bound = Q3 + 1.5 * IQR
                
                # è¯†åˆ«å¼‚å¸¸ç‚¹
                is_outlier = (residuals < lower_bound) | (residuals > upper_bound)
                
                # è·å–æ­£å¸¸ç‚¹çš„ç´¢å¼•å’Œå¼‚å¸¸ç‚¹çš„ç´¢å¼•
                valid_indices = [i for i, outlier in enumerate(is_outlier) if not outlier]
                outlier_indices = [i for i, outlier in enumerate(is_outlier) if outlier]
                
                # å¦‚æœè¿‡æ»¤åçš„æ•°æ®ç‚¹è¿‡å°‘ï¼Œå›é€€åˆ°ä¸è¿‡æ»¤
                if len(valid_indices) < max(3, len(x) * 0.5):
                    return [], x, y
                
                return outlier_indices, x[valid_indices], y[valid_indices]
            except:
                # å¦‚æœè®¡ç®—å‡ºé”™ï¼Œå›é€€åˆ°ä¸è¿‡æ»¤
                pass
        
        # é»˜è®¤ä¸è¿‡æ»¤
        return [], x, y
    
    def polynomial_fitting(self, x, y, degree):
        """å¤šé¡¹å¼æ‹Ÿåˆï¼Œè¿”å›ç³»æ•°ã€æ‹Ÿåˆå‡½æ•°ã€RÂ²å€¼å’Œæ®‹å·®"""
        # è¿›è¡Œå¤šé¡¹å¼æ‹Ÿåˆ
        coeffs = np.polyfit(x, y, degree)
        poly_func = np.poly1d(coeffs)
        
        # è®¡ç®—RÂ²å€¼
        y_mean = np.mean(y)
        ss_total = np.sum((y - y_mean)** 2)
        ss_residual = np.sum((y - poly_func(x))** 2)
        r_squared = 1 - (ss_residual / ss_total) if ss_total > 0 else 0
        
        # è®¡ç®—æ®‹å·®
        residuals = y - poly_func(x)
        
        return coeffs, poly_func, r_squared, residuals
    
    def evaluate_curve_quality(self, results):
        """è¯„ä¼°æ›²çº¿æ‹Ÿåˆè´¨é‡"""
        quality = {
            'goodness_of_fit': 'æœªçŸ¥',
            'data_representativeness': 'æœªçŸ¥'
        }
        
        # è¯„ä¼°æ‹Ÿåˆä¼˜åº¦
        if 'best_poly_fit' in results and results['best_poly_fit']:
            r_squared = results['best_poly_fit'].get('r_squared', 0)
            if r_squared >= 0.95:
                quality['goodness_of_fit'] = 'ä¼˜ç§€'
            elif r_squared >= 0.85:
                quality['goodness_of_fit'] = 'è‰¯å¥½'
            elif r_squared >= 0.70:
                quality['goodness_of_fit'] = 'ä¸€èˆ¬'
            elif r_squared >= 0.50:
                quality['goodness_of_fit'] = 'åŠæ ¼'
            else:
                quality['goodness_of_fit'] = 'ä¸åŠæ ¼'
        elif 'smooth_curve' in results and results['smooth_curve']:
            r_squared = results['smooth_curve'].get('r_squared', 0)
            if r_squared >= 0.90:
                quality['goodness_of_fit'] = 'ä¼˜ç§€'
            elif r_squared >= 0.80:
                quality['goodness_of_fit'] = 'è‰¯å¥½'
            elif r_squared >= 0.65:
                quality['goodness_of_fit'] = 'ä¸€èˆ¬'
            elif r_squared >= 0.50:
                quality['goodness_of_fit'] = 'åŠæ ¼'
            else:
                quality['goodness_of_fit'] = 'ä¸åŠæ ¼'
        
        # è¯„ä¼°æ•°æ®ä»£è¡¨æ€§
        n_original = len(results.get('original_data', [([], [])])[0])
        n_filtered = len(results.get('filtered_data', [([], [])])[0])
        if n_original > 0:
            outlier_ratio = 1 - n_filtered / n_original
        else:
            outlier_ratio = 0
        
        if outlier_ratio < 0.1 and n_filtered >= 10:
            quality['data_representativeness'] = 'ä¼˜ç§€'
        elif outlier_ratio < 0.2 and n_filtered >= 7:
            quality['data_representativeness'] = 'è‰¯å¥½'
        elif outlier_ratio < 0.3 and n_filtered >= 5:
            quality['data_representativeness'] = 'ä¸€èˆ¬'
        elif outlier_ratio < 0.4 and n_filtered >= 3:
            quality['data_representativeness'] = 'åŠæ ¼'
        else:
            quality['data_representativeness'] = 'ä¸åŠæ ¼'
        
        return quality
    
    def return_to_mode_select(self):
        """è¿”å›æ¨¡å¼é€‰æ‹©ç•Œé¢"""
        # å»¶è¿Ÿå¯¼å…¥ä»¥é¿å…å¾ªç¯å¯¼å…¥
        from gui.ui_choose_mode import ChooseModeWindow
        
        # å…³é—­å½“å‰çª—å£
        self.close()
        
        # åˆ›å»ºå¹¶æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©çª—å£
        self.mode_window = ChooseModeWindow()
        self.mode_window.show()

